name: Tests

on:
  push:
    branches: [ main, MAIN ]
  pull_request:
    branches: [ main, MAIN ]

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4  # Updated to v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4 # Updated to v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      working-directory: ./proj2/frontend  # FIXED PATH
      run: npm install
      
    - name: Run frontend tests
      working-directory: ./proj2/frontend  # FIXED PATH
      # ensuring lcov report is generated for easier codecov upload
      run: npm test -- --coverage --reporter=lcov 
      
    - name: Upload frontend coverage
      uses: codecov/codecov-action@v4 # Updated to v4
      with:
        # Removed explicit 'files' path to let Codecov auto-discover the lcov.info
        # If auto-discovery fails, use: ./proj2/frontend/coverage/lcov.info
        working-directory: ./proj2/frontend
        flags: frontend
        name: frontend-coverage
        token: ${{ secrets.CODECOV_TOKEN }} # v4 often requires token even for public repos

  backend-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5 # Updated to v5
      with:
        python-version: '3.10' # 3.x can sometimes be flaky; specific is better
        
    - name: Install backend dependencies
      working-directory: ./proj2/backend # FIXED PATH
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: Run backend tests
      working-directory: ./proj2/backend # FIXED PATH
      run: pytest --cov=. --cov-report=xml
      
    - name: Upload backend coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./proj2/backend/coverage.xml # FIXED PATH
        flags: backend
        name: backend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}
